# Create emiarchive-helm Kustomization
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: emiarchive-helm
spec:
  # Path inside repository to a directory containing Kustomization files
  path: tests/clusters/vm/main/databases/emiarchive/kustomize/emiarchive-helm/kustomize
  dependsOn:
    # Deploy namespace first
    - name: emiarchive-namespace
  # This key always needs to be here for patching to work
  patches:
    # Change volume size from HelmRelease values
    - target:
        group: helm.toolkit.fluxcd.io
        kind: HelmRelease
        name: emiarchive
      patch: |
        - op: replace
          path: /spec/values/volume/size
          value: 64Mi
    # Remove web URL from HelmRelease values
    - target:
        group: helm.toolkit.fluxcd.io
        kind: HelmRelease
        name: emiarchive
      patch: |
        - op: remove
          path: /spec/values/database/urls/web
