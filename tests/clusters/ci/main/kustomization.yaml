# Create main Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
# Include the following resources
resources:
  - apps
  - databases
  - infrastructure
# Apply patches for common configurations
patches:
  # Set namespace for all Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /metadata/namespace
        value: flux-system
  # Set source for Kustomizations
  # The repository is handled outside of GitOps
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
      name: .*
    patch: |
      kind: .
      metadata:
        name: .
      spec:
        sourceRef:
          kind: GitRepository
          name: main
  # Set interval for all Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
      name: .*
    patch: |
      kind: .
      metadata:
        name: .
      spec:
        interval: 1m
  # Make all Kustomizations prune resources
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
      name: .*
    patch: |
      kind: .
      metadata:
        name: .
      spec:
        prune: true
  # Make all Kustomizations wait for resources
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
      name: .*
    patch: |
      kind: .
      metadata:
        name: .
      spec:
        wait: true
  # Set patch to set namespace for all nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
          patch: |
            - op: add
              path: /metadata/namespace
              value: flux-system
  # Set patch to set source for nested Kustomizations
  # The repository is handled outside of GitOps
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: .*
          patch: |
            kind: .
            metadata:
              name: .
            spec:
              sourceRef:
                kind: GitRepository
                name: main
  # Set patch to set interval for all nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: .*
          patch: |
            kind: .
            metadata:
              name: .
            spec:
              interval: 1m
  # Set patch to make all nested Kustomizations prune resources
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: .*
          patch: |
            kind: .
            metadata:
              name: .
            spec:
              prune: true
  # Set patch to make all nested Kustomizations wait for resources
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
            name: .*
          patch: |
            kind: .
            metadata:
              name: .
            spec:
              wait: true
  # Set patch to add interval to HelmRepositories in nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
          patch: |
            - op: add
              path: /spec/patches/-
              value:
                target:
                  kind: HelmRepository
                  name: .*
                patch: |
                  kind: .
                  metadata:
                    name: .
                  spec:
                    interval: 1m
  # Set patch to add drift detection to HelmReleases in nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
          patch: |
            - op: add
              path: /spec/patches/-
              value:
                target:
                  kind: HelmRelease
                  name: .*
                patch: |
                  kind: .
                  metadata:
                    name: .
                  spec:
                    driftDetection:
                      mode: enabled
  # Set patch to add interval to HelmReleases in nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
          patch: |
            - op: add
              path: /spec/patches/-
              value:
                target:
                  kind: HelmRelease
                  name: .*
                patch: |
                  kind: .
                  metadata:
                    name: .
                  spec:
                    interval: 1m
  # Set patch to add interval to charts in HelmReleases in nested Kustomizations
  - target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
    patch: |
      - op: add
        path: /spec/patches/-
        value:
          target:
            group: kustomize.toolkit.fluxcd.io
            kind: Kustomization
          patch: |
            - op: add
              path: /spec/patches/-
              value:
                target:
                  kind: HelmRelease
                  name: .*
                patch: |
                  kind: .
                  metadata:
                    name: .
                  spec:
                    chart:
                      spec:
                        interval: 1m
