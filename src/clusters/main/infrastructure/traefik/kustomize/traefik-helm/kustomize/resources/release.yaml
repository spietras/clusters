# Create traefik Helm release
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
spec:
  chart:
    spec:
      # Use this chart from the repository
      chart: traefik
      # Use this Helm repository
      sourceRef:
        kind: HelmRepository
        name: traefik
  # This key always needs to be here for patching to work
  postRenderers: []
  values:
    additionalArguments:
      # Allow backends to use self-signed certificates
      - --serversTransport.insecureSkipVerify=true
    ports:
      # Port for web traffic
      web:
        # Expose it outside the cluster
        expose: true
        # Expose it on this port
        exposedPort: 80
        # Web traffic uses TCP
        protocol: TCP
        # Port to use inside the cluster
        port: 8000
      # Port for secure web traffic
      websecure:
        # Expose it outside the cluster
        expose: true
        # Expose it on this port
        exposedPort: 443
        # Secure web traffic uses TCP
        protocol: TCP
        # Port to use inside the cluster
        port: 8443
        # Enable TLS
        tls:
          enabled: true
      # Port for fusion SRT traffic
      fusion-srt:
        # Expose it outside the cluster
        expose: true
        # Expose it on this port
        exposedPort: 9999
        # fusion SRT traffic uses UDP
        protocol: UDP
        # Port to use inside the cluster
        port: 9999
      # Port for emishows-db SQL traffic
      emishows-db-sql:
        # Expose it outside the cluster
        expose: true
        # Expose it on this port
        exposedPort: 9998
        # emishows-db SQL traffic uses TCP
        protocol: TCP
        # Port to use inside the cluster
        port: 9998
      # Port for emishows-db RPC traffic
      emishows-db-rpc:
        # Expose it outside the cluster
        expose: true
        # Expose it on this port
        exposedPort: 9997
        # emishows-db RPC traffic uses TCP
        protocol: TCP
        # Port to use inside the cluster
        port: 9997
    service:
      annotations:
        # Use custom machine name in Tailscale
        tailscale.com/hostname: traefik
      # Use Tailscale LoadBalancer
      loadBalancerClass: tailscale
